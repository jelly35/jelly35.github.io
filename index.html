<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ê·¼ì²˜ ìµœì €ê°€ ì˜ˆë°©ì ‘ì¢… ì°¾ê¸°</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', 'Inter', sans-serif; background-color: #f0f2f5; }
        .toss-card {
            background-color: white;
            border-radius: 1.5rem; /* 24px */
            padding: 2rem; /* 32px */
            box-shadow: 0 8px G30px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        .toss-button {
            border-radius: 0.75rem; /* 12px */
            font-weight: 700;
            transition: all 0.2s ease;
        }
        .toss-button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
        .loader {
            border: 5px solid #e0e7ff;
            border-top: 5px solid #4f46e5;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">

    <div class="max-w-3xl mx-auto p-4 md:p-6">
        <!-- í—¤ë” -->
        <header class="py-8 text-center">
            <h1 class="text-4xl md:text-5xl font-black text-gray-800 leading-tight">
                ë‚´ ê·¼ì²˜ ìµœì €ê°€<br>
                <span class="text-indigo-600">ì˜ˆë°©ì ‘ì¢…</span> ë³‘ì› ì°¾ê¸°
            </h1>
            <p class="mt-4 text-gray-500">ì‹¬í‰ì› ë°ì´í„°ë¡œ ê°€ì¥ í•©ë¦¬ì ì¸ ë³‘ì›ì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
        </header>

        <!-- ë©”ì¸ ì»¨íŠ¸ë¡¤ ì¹´ë“œ -->
        <main class="toss-card space-y-8">
            <div>
                <h2 class="text-2xl font-bold mb-1">ì–´ë–¤ ì ‘ì¢…ì„ ì°¾ìœ¼ì„¸ìš”?</h2>
                <p class="text-gray-500">ê¶ê¸ˆí•œ ì˜ˆë°©ì ‘ì¢… í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                <button id="open-vaccine-modal-btn" class="mt-4 w-full flex justify-between items-center text-left bg-gray-100 hover:bg-gray-200 p-4 rounded-xl transition-colors">
                    <span id="selected-vaccines-display" class="font-semibold text-gray-700">ì˜ˆë°©ì ‘ì¢… í•­ëª© ì„ íƒí•˜ê¸°</span>
                    <i class="fa-solid fa-chevron-right text-gray-500"></i>
                </button>
            </div>

            <div>
                 <h2 class="text-2xl font-bold mb-4">ì–´ë””ì—ì„œ ë§ìœ¼ì„¸ìš”?</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="sido-select" class="text-sm font-medium text-gray-700">ì‹œ/ë„</label>
                        <select id="sido-select" class="mt-1 w-full p-3 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                     <div>
                        <label for="sggu-select" class="text-sm font-medium text-gray-700">ì‹œ/êµ°/êµ¬</label>
                        <select id="sggu-select" class="mt-1 w-full p-3 border border-gray-200 rounded-lg bg-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" disabled></select>
                    </div>
                     <div class="sm:col-span-2">
                        <label for="hospital-type-select" class="text-sm font-medium text-gray-700">ë³‘ì› ì¢…ë¥˜ (ì„ íƒ)</label>
                        <select id="hospital-type-select" class="mt-1 w-full p-3 border border-gray-200 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                 </div>
            </div>

            <button id="search-btn" class="w-full bg-indigo-600 text-white text-lg py-4 toss-button">
                <i class="fa-solid fa-magnifying-glass mr-2"></i>ì¡°íšŒí•˜ê¸°
            </button>
        </main>
        
        <!-- ê²°ê³¼ ì˜ì—­ -->
        <section id="result-section" class="mt-10">
            <div id="loader" class="hidden justify-center items-center py-10 flex-col">
                <div class="loader"></div>
                <p id="loader-message" class="mt-4 text-gray-600 font-semibold">ë³‘ì› ì°¾ëŠ” ì¤‘...</p>
            </div>

            <div id="result-message" class="hidden text-center py-16">
                 <div class="text-5xl mb-4">ğŸ˜…</div>
                 <p class="text-xl font-bold text-gray-700">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”</p>
                 <p class="text-gray-500 mt-2">ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•´ë³´ì„¸ìš”!</p>
            </div>
            
            <div id="result-container" class="hidden">
                 <div class="mb-6 flex justify-between items-center">
                    <h2 class="text-2xl font-bold">ê²€ìƒ‰ ê²°ê³¼ <span id="result-count" class="text-indigo-600">0</span></h2>
                    <select id="sort-select" class="px-3 py-2 border border-gray-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500">
                        <option value="price_asc">ê°€ê²© ë‚®ì€ìˆœ</option>
                        <option value="price_desc">ê°€ê²© ë†’ì€ìˆœ</option>
                        <option value="name_asc">ì´ë¦„ìˆœ</option>
                    </select>
                </div>
                <div id="result-list" class="space-y-4">
                    <!-- ê²°ê³¼ ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤. -->
                </div>
            </div>
        </section>

    </div>

    <!-- ì˜ˆë°©ì ‘ì¢… ì„ íƒ ëª¨ë‹¬ -->
    <div id="vaccine-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden">
            <header class="p-5 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">ì˜ˆë°©ì ‘ì¢… ì„ íƒ</h2>
                <button id="close-vaccine-modal-btn" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            </header>
            <div id="vaccine-tree-container" class="p-2 sm:p-4 overflow-y-auto">
                <div id="vaccine-tree-loader" class="flex justify-center items-center p-8"><div class="loader"></div></div>
            </div>
            <footer class="p-4 bg-gray-50 border-t">
                <button id="apply-selection-btn" class="w-full bg-indigo-600 text-white text-lg py-3 toss-button">ì„ íƒ ì™„ë£Œ</button>
            </footer>
        </div>
    </div>

    <script>
        const API = {
            CODE: 'https://apis.data.go.kr/B551182/nonPaymentDamtInfoService/getNonPaymentItemCodeList2',
            HOSP: 'https://apis.data.go.kr/B551182/nonPaymentDamtInfoService/getNonPaymentItemHospList2',
            KEY: '1GfsTIIMFiekflcfACHmDYWdvnysQzqtwj+YDYvTxihHrxEOZM13CrEIkprA6Q8lqOlDOkOP3ouzoPiuuPu6Cw=='
        };
        const CACHE_KEY = 'vaccineDataCache';
        const hospitalTypes = { "01": "ìƒê¸‰ì¢…í•©", "11": "ì¢…í•©ë³‘ì›", "21": "ë³‘ì›", "31": "ì˜ì›", "41": "ì¹˜ê³¼ë³‘ì›", "42": "ì¹˜ê³¼ì˜ì›", "51": "í•œë°©ë³‘ì›", "61": "í•œì˜ì›", "71": "ìš”ì–‘ë³‘ì›" };
        const locationData = { "110000": { name: "ì„œìš¸íŠ¹ë³„ì‹œ", sggu: { "110016": "ê°•ë‚¨êµ¬", "110002": "ê°•ë™êµ¬", "110003": "ê°•ë¶êµ¬", "110004": "ê°•ì„œêµ¬", "110005": "ê´€ì•…êµ¬", "110006": "ê´‘ì§„êµ¬", "110007": "êµ¬ë¡œêµ¬", "110008": "ê¸ˆì²œêµ¬", "110009": "ë…¸ì›êµ¬", "110010": "ë„ë´‰êµ¬", "110011": "ë™ëŒ€ë¬¸êµ¬", "110012": "ë™ì‘êµ¬", "110013": "ë§ˆí¬êµ¬", "110014": "ì„œëŒ€ë¬¸êµ¬", "110015": "ì„œì´ˆêµ¬", "110017": "ì„±ë™êµ¬", "110018": "ì„±ë¶êµ¬", "110019": "ì†¡íŒŒêµ¬", "110020": "ì–‘ì²œêµ¬", "110021": "ì˜ë“±í¬êµ¬", "110022": "ìš©ì‚°êµ¬", "110023": "ì€í‰êµ¬", "110001": "ì¢…ë¡œêµ¬", "110024": "ì¤‘êµ¬", "110025": "ì¤‘ë‘êµ¬" }}, "260000": { name: "ë¶€ì‚°ê´‘ì—­ì‹œ", sggu: { "260005": "ê°•ì„œêµ¬", "260006": "ê¸ˆì •êµ¬", "260007": "ê¸°ì¥êµ°", "260008": "ë‚¨êµ¬", "260009": "ë™êµ¬", "260010": "ë™ë˜êµ¬", "260011": "ë¶€ì‚°ì§„êµ¬", "260012": "ë¶êµ¬", "260013": "ì‚¬ìƒêµ¬", "260014": "ì‚¬í•˜êµ¬", "260001": "ì„œêµ¬", "260015": "ìˆ˜ì˜êµ¬", "260016": "ì—°ì œêµ¬", "260002": "ì˜ë„êµ¬", "260003": "ì¤‘êµ¬", "260004": "í•´ìš´ëŒ€êµ¬" }}, "270000": { name: "ëŒ€êµ¬ê´‘ì—­ì‹œ", sggu: { "270003": "ë‚¨êµ¬", "270004": "ë‹¬ì„œêµ¬", "270005": "ë‹¬ì„±êµ°", "270006": "ë™êµ¬", "270007": "ë¶êµ¬", "270001": "ì„œêµ¬", "270008": "ìˆ˜ì„±êµ¬", "270002": "ì¤‘êµ¬" }}, "280000": { name: "ì¸ì²œê´‘ì—­ì‹œ", sggu: { "280003": "ê°•í™”êµ°", "280004": "ê³„ì–‘êµ¬", "280005": "ë‚¨ë™êµ¬", "280006": "ë™êµ¬", "280007": "ë¯¸ì¶”í™€êµ¬", "280008": "ë¶€í‰êµ¬", "280009": "ì„œêµ¬", "280010": "ì—°ìˆ˜êµ¬", "280002": "ì˜¹ì§„êµ°", "280001": "ì¤‘êµ¬" }}, "290000": { name: "ê´‘ì£¼ê´‘ì—­ì‹œ", sggu: { "290002": "ê´‘ì‚°êµ¬", "290003": "ë‚¨êµ¬", "290004": "ë™êµ¬", "290005": "ë¶êµ¬", "290001": "ì„œêµ¬" }}, "300000": { name: "ëŒ€ì „ê´‘ì—­ì‹œ", sggu: { "300002": "ëŒ€ë•êµ¬", "300003": "ë™êµ¬", "300004": "ì„œêµ¬", "300005": "ìœ ì„±êµ¬", "300001": "ì¤‘êµ¬" }}, "310000": { name: "ìš¸ì‚°ê´‘ì—­ì‹œ", sggu: { "310002": "ë‚¨êµ¬", "310003": "ë™êµ¬", "310004": "ë¶êµ¬", "310005": "ìš¸ì£¼êµ°", "310001": "ì¤‘êµ¬" }}, "360000": { name: "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ", sggu: {}}, "410000": { name: "ê²½ê¸°ë„", sggu: { "410004": "ê°€í‰êµ°", "410005": "ê³ ì–‘ì‹œ", "410006": "ê³¼ì²œì‹œ", "410007": "ê´‘ëª…ì‹œ", "410008": "ê´‘ì£¼ì‹œ", "410009": "êµ¬ë¦¬ì‹œ", "410010": "êµ°í¬ì‹œ", "410011": "ê¹€í¬ì‹œ", "410012": "ë‚¨ì–‘ì£¼ì‹œ", "410013": "ë™ë‘ì²œì‹œ", "410014": "ë¶€ì²œì‹œ", "410015": "ì„±ë‚¨ì‹œ", "410016": "ìˆ˜ì›ì‹œ", "410017": "ì‹œí¥ì‹œ", "410018": "ì•ˆì‚°ì‹œ", "410019": "ì•ˆì„±ì‹œ", "410020": "ì•ˆì–‘ì‹œ", "410021": "ì–‘ì£¼ì‹œ", "410022": "ì–‘í‰êµ°", "410023": "ì—¬ì£¼ì‹œ", "410024": "ì—°ì²œêµ°", "410025": "ì˜¤ì‚°ì‹œ", "410026": "ìš©ì¸ì‹œ", "410027": "ì˜ì™•ì‹œ", "410028": "ì˜ì •ë¶€ì‹œ", "410029": "ì´ì²œì‹œ", "410030": "íŒŒì£¼ì‹œ", "410031": "í‰íƒì‹œ", "410032": "í¬ì²œì‹œ", "410033": "í•˜ë‚¨ì‹œ", "410034": "í™”ì„±ì‹œ" }}, "420000": { name: "ê°•ì›ë„", sggu: { "420002": "ê°•ë¦‰ì‹œ", "420003": "ê³ ì„±êµ°", "420004": "ë™í•´ì‹œ", "420005": "ì‚¼ì²™ì‹œ", "420006": "ì†ì´ˆì‹œ", "420007": "ì–‘êµ¬êµ°", "420008": "ì–‘ì–‘êµ°", "420009": "ì˜ì›”êµ°", "420010": "ì›ì£¼ì‹œ", "420011": "ì¸ì œêµ°", "420012": "ì •ì„ êµ°", "420013": "ì² ì›êµ°", "420001": "ì¶˜ì²œì‹œ", "420014": "íƒœë°±ì‹œ", "420015": "í‰ì°½êµ°", "420016": "í™ì²œêµ°", "420017": "í™”ì²œêµ°", "420018": "íš¡ì„±êµ°" }}, "430000": { name: "ì¶©ì²­ë¶ë„", sggu: { "430003": "ê´´ì‚°êµ°", "430004": "ë‹¨ì–‘êµ°", "430005": "ë³´ì€êµ°", "430006": "ì˜ë™êµ°", "430007": "ì˜¥ì²œêµ°", "430008": "ìŒì„±êµ°", "430009": "ì œì²œì‹œ", "430010": "ì¦í‰êµ°", "430011": "ì§„ì²œêµ°", "430001": "ì²­ì£¼ì‹œ", "430002": "ì¶©ì£¼ì‹œ" }}, "440000": { name: "ì¶©ì²­ë‚¨ë„", sggu: { "440003": "ê³„ë£¡ì‹œ", "440004": "ê³µì£¼ì‹œ", "440005": "ê¸ˆì‚°êµ°", "440006": "ë…¼ì‚°ì‹œ", "440007": "ë‹¹ì§„ì‹œ", "440008": "ë³´ë ¹ì‹œ", "440009": "ë¶€ì—¬êµ°", "440010": "ì„œì‚°ì‹œ", "440011": "ì„œì²œêµ°", "440012": "ì•„ì‚°ì‹œ", "440014": "ì˜ˆì‚°êµ°", "440001": "ì²œì•ˆì‹œ", "440015": "ì²­ì–‘êµ°", "440016": "íƒœì•ˆêµ°", "440017": "í™ì„±êµ°" }}, "450000": { name: "ì „ë¼ë¶ë„", sggu: { "450003": "ê³ ì°½êµ°", "450004": "êµ°ì‚°ì‹œ", "450005": "ê¹€ì œì‹œ", "450006": "ë‚¨ì›ì‹œ", "450007": "ë¬´ì£¼êµ°", "450008": "ë¶€ì•ˆêµ°", "450009": "ìˆœì°½êµ°", "450010": "ì™„ì£¼êµ°", "450011": "ìµì‚°ì‹œ", "450012": "ì„ì‹¤êµ°", "450013": "ì¥ìˆ˜êµ°", "450001": "ì „ì£¼ì‹œ", "450014": "ì •ìì‹œ", "450015": "ì§„ì•ˆêµ°" }}, "460000": { name: "ì „ë¼ë‚¨ë„", sggu: { "460003": "ê°•ì§„êµ°", "460004": "ê³ í¥êµ°", "460005": "ê³¡ì„±êµ°", "460006": "ê´‘ì–‘ì‹œ", "460007": "êµ¬ë¡€êµ°", "460008": "ë‚˜ì£¼ì‹œ", "460009": "ë‹´ì–‘êµ°", "460001": "ëª©í¬ì‹œ", "460010": "ë¬´ì•ˆêµ°", "460011": "ë³´ì„±êµ°", "460012": "ìˆœì²œì‹œ", "460013": "ì‹ ì•ˆêµ°", "460002": "ì—¬ìˆ˜ì‹œ", "460014": "ì˜ê´‘êµ°", "460015": "ì˜ì•”êµ°", "460016": "ì™„ë„êµ°", "460017": "ì¥ì„±êµ°", "460018": "ì¥í¥êµ°", "460019": "ì§„ë„êµ°", "460020": "í•¨í‰êµ°", "460021": "í•´ë‚¨êµ°", "460022": "í™”ìˆœêµ°" }}, "470000": { name: "ê²½ìƒë¶ë„", sggu: { "470002": "ê²½ì‚°ì‹œ", "470003": "ê²½ì£¼ì‹œ", "470004": "ê³ ë ¹êµ°", "470005": "êµ¬ë¯¸ì‹œ", "470006": "êµ°ìœ„êµ°", "470007": "ê¹€ì²œì‹œ", "470008": "ë¬¸ê²½ì‹œ", "470009": "ë´‰í™”êµ°", "470010": "ìƒì£¼ì‹œ", "470011": "ì„±ì£¼êµ°", "470012": "ì•ˆë™ì‹œ", "470013": "ì˜ë•êµ°", "470014": "ì˜ì–‘êµ°", "470015": "ì˜ì£¼ì‹œ", "470016": "ì˜ì²œì‹œ", "470017": "ì˜ˆì²œêµ°", "470018": "ìš¸ë¦‰êµ°", "470019": "ìš¸ì§„êµ°", "470020": "ì˜ì„±êµ°", "470021": "ì²­ë„êµ°", "470022": "ì²­ì†¡êµ°", "470023": "ì¹ ê³¡êµ°", "470001": "í¬í•­ì‹œ" }}, "480000": { name: "ê²½ìƒë‚¨ë„", sggu: { "480003": "ê±°ì œì‹œ", "480004": "ê±°ì°½êµ°", "480005": "ê³ ì„±êµ°", "480006": "ê¹€í•´ì‹œ", "480007": "ë‚¨í•´êµ°", "480008": "ë°€ì–‘ì‹œ", "480009": "ì‚¬ì²œì‹œ", "480010": "ì‚°ì²­êµ°", "480011": "ì–‘ì‚°ì‹œ", "480012": "ì˜ë ¹êµ°", "480013": "ì§„ì£¼ì‹œ", "480001": "ì°½ì›ì‹œ", "480014": "ì°½ë…•êµ°", "480015": "í†µì˜ì‹œ", "480016": "í•˜ë™êµ°", "480017": "í•¨ì•ˆêµ°", "480018": "í•¨ì–‘êµ°", "480019": "í•©ì²œêµ°" }}, "500000": { name: "ì œì£¼íŠ¹ë³„ìì¹˜ë„", sggu: { "500001": "ì„œê·€í¬ì‹œ", "500002": "ì œì£¼ì‹œ" }} };
        let currentResults = [];

        const D = {
            loader: document.getElementById('loader'), loaderMessage: document.getElementById('loader-message'),
            resultMsg: document.getElementById('result-message'), resultContainer: document.getElementById('result-container'),
            resultList: document.getElementById('result-list'), resultCount: document.getElementById('result-count'),
            modal: { el: document.getElementById('vaccine-modal'), openBtn: document.getElementById('open-vaccine-modal-btn'), closeBtn: document.getElementById('close-vaccine-modal-btn'), treeContainer: document.getElementById('vaccine-tree-container'), applyBtn: document.getElementById('apply-selection-btn') },
            filters: { hospType: document.getElementById('hospital-type-select'), sido: document.getElementById('sido-select'), sggu: document.getElementById('sggu-select'), sort: document.getElementById('sort-select') },
            searchBtn: document.getElementById('search-btn'), selectedVaccinesDisplay: document.getElementById('selected-vaccines-display')
        };
        
        const showLoader = (msg) => { D.loaderMessage.textContent = msg; D.loader.style.display = 'flex'; D.resultContainer.classList.add('hidden'); D.resultMsg.classList.add('hidden'); };
        const hideLoader = () => D.loader.style.display = 'none';
        const showMessage = () => { D.resultList.innerHTML = ''; D.resultContainer.classList.add('hidden'); D.resultMsg.classList.remove('hidden'); };
        const formatPrice = (p) => { const n = Number(p); return (!isNaN(n) && n > 0) ? `${n.toLocaleString('ko-KR')}ì›` : 'ë¬¸ì˜'; };
        const formatDate = (d) => d && d.length === 8 ? `${d.substring(0,4)}.${d.substring(4,6)}.${d.substring(6,8)}` : '-';

        async function getGroupedVaccineData() {
            const cachedData = sessionStorage.getItem(CACHE_KEY);
            if (cachedData) return JSON.parse(cachedData);
            
            const url = `${API.CODE}?serviceKey=${encodeURIComponent(API.KEY)}&numOfRows=999`;
            const response = await fetch(url);
            const xmlString = await response.text();
            const xmlDoc = new DOMParser().parseFromString(xmlString, "application/xml");
            
            if (xmlDoc.querySelector('resultCode').textContent !== '00') throw new Error("APIì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            
            const vaccineKeywords = ['ì ‘ì¢…', 'ë°±ì‹ ', 'ê°€ë‹¤ì‹¤', 'ì„œë°”ë¦­ìŠ¤', 'ìê¶ê²½ë¶€ì•”', 'ì¸í”Œë£¨ì—”ì', 'ë…ê°', 'ëŒ€ìƒí¬ì§„', 'í”„ë¦¬ë² ë‚˜', 'ì‹ í”Œë¡œë¦­ìŠ¤', 'ë¡œíƒ€'];
            const groups = {};

            Array.from(xmlDoc.querySelectorAll('item')).forEach(item => {
                const fullName = item.querySelector('npayKorNm')?.textContent;
                if (!fullName || !vaccineKeywords.some(kw => fullName.includes(kw))) return;
                
                let cleanName = fullName.startsWith('ì˜ˆë°©ì ‘ì¢…ë£Œ/') ? fullName.substring(6) : fullName;
                const code = item.querySelector('npayCd').textContent;
                const parts = cleanName.split('/');
                const groupName = parts[0];
                
                if (groupName === "ì˜ˆë°©ì ‘ì¢…ë£Œ") return;

                if (!groups[groupName]) groups[groupName] = { code: null, children: {} };
                if (parts.length === 1) groups[groupName].code = code;
                else groups[groupName].children[parts.slice(1).join('/')] = { code };
            });
            
            sessionStorage.setItem(CACHE_KEY, JSON.stringify(groups));
            return groups;
        }
        
        function buildVaccineTreeUI(groups) {
            D.modal.treeContainer.innerHTML = '';
            const sortedGroupNames = Object.keys(groups).sort((a,b) => a.localeCompare(b));

            sortedGroupNames.forEach(groupName => {
                const group = groups[groupName];
                const hasChildren = Object.keys(group.children).length > 0;
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'border-b last:border-b-0';
                const header = document.createElement('div');
                header.className = 'flex items-center p-4 cursor-pointer hover:bg-gray-100';
                
                header.innerHTML = `
                    <input type="checkbox" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md mr-4 parent-check" data-group-name="${groupName}">
                    <span class="font-semibold flex-1">${groupName}</span>
                    ${hasChildren ? '<i class="fa-solid fa-chevron-down text-gray-400 transition-transform"></i>' : ''}`;
                groupDiv.appendChild(header);

                if(hasChildren) {
                    const content = document.createElement('div');
                    content.className = 'accordion-content bg-gray-50/70 pl-10 pr-4 py-1';
                    const sortedChildNames = Object.keys(group.children).sort();
                    sortedChildNames.forEach(childName => {
                        const child = group.children[childName];
                        content.innerHTML += `
                            <label class="flex items-center p-3 hover:bg-gray-200/70 rounded-md">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-500 rounded-md mr-3 child-check" data-code="${child.code}" data-parent-group="${groupName}" data-name="${childName}">
                                <span class="text-sm">${childName}</span></label>`;
                    });
                    groupDiv.appendChild(content);
                }
                D.modal.treeContainer.appendChild(groupDiv);
            });
        }

        async function searchHospitals() {
            const codesToSearch = new Map(); // Use Map to store {code: name} to avoid duplicates
            
            // Get checked parent groups
            D.modal.treeContainer.querySelectorAll('.parent-check:checked').forEach(pcb => {
                const groupName = pcb.dataset.groupName;
                const groupData = window.vaccineData[groupName];
                
                // Add all children of the checked parent group
                Object.entries(groupData.children).forEach(([childName, childData]) => {
                    codesToSearch.set(childData.code, childName);
                });
                // If the parent itself is a vaccine (has a code and no children), add it
                if (groupData.code && Object.keys(groupData.children).length === 0) {
                     codesToSearch.set(groupData.code, groupName);
                }
            });

            // Get individually checked children (if their parent is not checked)
            D.modal.treeContainer.querySelectorAll('.child-check:checked').forEach(ccb => {
                const parentCb = D.modal.treeContainer.querySelector(`.parent-check[data-group-name="${ccb.dataset.parentGroup}"]`);
                if (!parentCb.checked) {
                    codesToSearch.set(ccb.dataset.code, ccb.dataset.name);
                }
            });

            if (codesToSearch.size === 0) {
                showMessage("ì˜ˆë°©ì ‘ì¢… í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            showLoader(`${codesToSearch.size}ê°œ í•­ëª© ì½”ë“œë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...`);
            
            const searchParams = { clCd: D.filters.hospType.value, sidoCd: D.filters.sido.value, sgguCd: D.filters.sggu.value };
            // Create an array of promises, passing both code and name
            const promises = Array.from(codesToSearch.entries()).map(([code, name]) => fetchHospitalDataForCode({code, name}, searchParams));
            
            try {
                const results = await Promise.all(promises);
                const allItems = results.flat();
                
                const mergedHospitals = {};
                allItems.forEach(item => {
                    const ykiho = item.ykiho;
                    if (!mergedHospitals[ykiho]) {
                        mergedHospitals[ykiho] = {
                            yadmNm: item.yadmNm, clCdNm: item.clCdNm,
                            vaccines: []
                        };
                    }
                    mergedHospitals[ykiho].vaccines.push({
                        name: item.vaccineName,
                        minPrc: item.minPrc,
                        maxPrc: item.maxPrc,
                        adtFrDd: item.adtFrDd
                    });
                });
                
                // Calculate overall price range for sorting
                currentResults = Object.values(mergedHospitals).map(hosp => {
                    const prices = hosp.vaccines.map(v => v.minPrc).filter(p => p > 0);
                    hosp.overallMinPrc = prices.length > 0 ? Math.min(...prices) : 0;
                    return hosp;
                });

                displayResults();
            } catch (error) {
                showMessage(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
            } finally {
                hideLoader();
            }
        }

        async function fetchHospitalDataForCode(vaccineInfo, params) {
            let url = new URL(API.HOSP);
            url.searchParams.set('serviceKey', API.KEY);
            url.searchParams.set('itemCd', vaccineInfo.code);
            url.searchParams.set('numOfRows', 500);
            if (params.clCd) url.searchParams.set('clCd', params.clCd);
            if (params.sidoCd) url.searchParams.set('sidoCd', params.sidoCd);
            if (params.sgguCd) url.searchParams.set('sgguCd', params.sgguCd);

            try {
                const response = await fetch(url);
                const xmlString = await response.text();
                const xmlDoc = new DOMParser().parseFromString(xmlString, "application/xml");
                if (xmlDoc.querySelector('resultCode').textContent !== '00') return [];
                
                // Return a mapped array with necessary info
                return Array.from(xmlDoc.querySelectorAll('item')).map(item => ({
                    vaccineName: vaccineInfo.name, // Add the vaccine name to each hospital item
                    ykiho: item.querySelector('ykiho').textContent,
                    yadmNm: item.querySelector('yadmNm').textContent,
                    clCdNm: item.querySelector('clCdNm').textContent,
                    minPrc: Number(item.querySelector('minPrc')?.textContent || '0'),
                    maxPrc: Number(item.querySelector('maxPrc')?.textContent || '0'),
                    adtFrDd: item.querySelector('adtFrDd')?.textContent
                }));
            } catch(e) {
                console.error(`Failed to fetch for code ${vaccineInfo.code}:`, e);
                return []; // Return empty array on fetch error
            }
        }

        function displayResults() {
            const sortedItems = [...currentResults].sort((a, b) => {
                switch (D.filters.sort.value) {
                    case 'price_desc':
                        const maxA = Math.max(...a.vaccines.map(v => v.maxPrc));
                        const maxB = Math.max(...b.vaccines.map(v => v.maxPrc));
                        return maxB - maxA;
                    case 'name_asc': return a.yadmNm.localeCompare(b.yadmNm);
                    default: return (a.overallMinPrc || Infinity) - (b.overallMinPrc || Infinity);
                }
            });

            D.resultList.innerHTML = '';
            D.resultCount.textContent = sortedItems.length;

            if (sortedItems.length === 0) {
                showMessage();
                return;
            }
            D.resultContainer.classList.remove('hidden');
            D.resultMsg.classList.add('hidden');
            
            sortedItems.forEach(item => {
                const card = document.createElement('div');
                card.className = "toss-card";
                
                const vaccineListHtml = item.vaccines.sort((a,b) => a.minPrc - b.minPrc).map(v => `
                    <div class="py-3 flex justify-between items-center text-sm">
                        <span class="font-medium text-gray-700">${v.name}</span>
                        <div class="text-right">
                           <span class="font-bold text-gray-800">${formatPrice(v.minPrc)} ${v.maxPrc > v.minPrc ? ` ~ ${formatPrice(v.maxPrc)}` : ''}</span>
                           <p class="text-xs text-gray-400">ê¸°ì¤€ì¼: ${formatDate(v.adtFrDd)}</p>
                        </div>
                    </div>
                `).join('<hr class="border-gray-100">');

                card.innerHTML = `
                    <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-indigo-600">${item.clCdNm}</p>
                            <h3 class="text-xl font-bold mt-1">${item.yadmNm}</h3>
                        </div>
                        <div class="text-right flex-shrink-0">
                             <p class="text-lg sm:text-xl font-bold text-gray-800">${formatPrice(item.overallMinPrc)} ~</p>
                        </div>
                    </div>
                    <div class="mt-4 border-t border-gray-100">
                        ${vaccineListHtml}
                    </div>
                `;
                D.resultList.appendChild(card);
            });
        }

        function setupEventListeners() {
            D.modal.openBtn.onclick = () => D.modal.el.style.display = 'flex';
            D.modal.closeBtn.onclick = () => D.modal.el.style.display = 'none';
            D.modal.applyBtn.onclick = () => {
                const selectedNames = Array.from(D.modal.treeContainer.querySelectorAll('.child-check:checked')).map(cb => cb.dataset.name);
                const parentOnlySelected = Array.from(D.modal.treeContainer.querySelectorAll('.parent-check:checked')).filter(pcb => !D.modal.treeContainer.querySelector(`.child-check[data-parent-group="${pcb.dataset.groupName}"]:checked`)).map(pcb => pcb.dataset.groupName);
                const allSelections = [...new Set([...parentOnlySelected, ...selectedNames])];
                D.selectedVaccinesDisplay.textContent = allSelections.length > 0 ? `${allSelections[0]}` + (allSelections.length > 1 ? ` ì™¸ ${allSelections.length - 1}ê±´` : '') : 'ì˜ˆë°©ì ‘ì¢… í•­ëª© ì„ íƒí•˜ê¸°';
                D.modal.el.style.display = 'none';
            };

            D.modal.treeContainer.addEventListener('click', (e) => {
                const target = e.target;
                if (target.closest('.flex.items-center.p-4')) {
                    const header = target.closest('.flex.items-center.p-4');
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('i');
                    if (content?.classList.contains('accordion-content')) {
                        content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
                        icon?.classList.toggle('rotate-180');
                    }
                }
                if (target.classList.contains('parent-check')) {
                    D.modal.treeContainer.querySelectorAll(`.child-check[data-parent-group="${target.dataset.groupName}"]`).forEach(child => child.checked = target.checked);
                }
                if (target.classList.contains('child-check')) {
                    const groupName = target.dataset.parentGroup;
                    const parent = D.modal.treeContainer.querySelector(`.parent-check[data-group-name="${groupName}"]`);
                    const allChildren = D.modal.treeContainer.querySelectorAll(`.child-check[data-parent-group="${groupName}"]`);
                    const allChecked = Array.from(allChildren).every(child => child.checked);
                    const someChecked = Array.from(allChildren).some(child => child.checked);
                    parent.checked = allChecked;
                    parent.indeterminate = !allChecked && someChecked;
                }
            });
            
            D.filters.sido.onchange = () => {
                const selectedSido = D.filters.sido.value;
                D.filters.sggu.innerHTML = '<option value="">ì‹œ/êµ°/êµ¬ ì „ì²´</option>';
                D.filters.sggu.disabled = true;
                D.filters.sggu.classList.add('bg-gray-100');
                if (selectedSido && locationData[selectedSido].sggu && Object.keys(locationData[selectedSido].sggu).length > 0) {
                    D.filters.sggu.disabled = false;
                    D.filters.sggu.classList.remove('bg-gray-100');
                    Object.entries(locationData[selectedSido].sggu).forEach(([code, name]) => D.filters.sggu.add(new Option(name, code)));
                }
            };

            D.filters.sort.onchange = displayResults;
            D.searchBtn.onclick = searchHospitals;
        }

        async function initialize() {
            try {
                window.vaccineData = await getGroupedVaccineData();
                buildVaccineTreeUI(window.vaccineData);
            } catch (e) {
                D.modal.treeContainer.innerHTML = `<p class="text-red-500 text-center">${e.message}</p>`;
            }
            D.filters.hospType.innerHTML = `<option value="">ë³‘ì› ì¢…ë¥˜ ì „ì²´</option>`;
            Object.entries(hospitalTypes).forEach(([code, name]) => D.filters.hospType.add(new Option(name, code)));
            D.filters.sido.innerHTML = `<option value="">ì‹œ/ë„ ì „ì²´</option>`;
            Object.entries(locationData).forEach(([code, data]) => D.filters.sido.add(new Option(data.name, code)));
            setupEventListeners();
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
